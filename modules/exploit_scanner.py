import socket
import requests
from rich.console import Console
from rich.table import Table

console = Console()

VULN_PORTS = {
    21: {"service": "FTP", "vulns": ["CVE-2015-3306 ProFTPd", "CVE-2011-2523 vsftpd 2.3.4 Backdoor", "Anonymous Login"]},
    22: {"service": "SSH", "vulns": ["CVE-2018-15473 User Enumeration", "CVE-2016-0777 Roaming Bug", "Weak Password"]},
    23: {"service": "Telnet", "vulns": ["CVE-2020-10188 Telnet Overflow", "Plaintext Credentials", "Default Credentials"]},
    25: {"service": "SMTP", "vulns": ["CVE-2019-10149 Exim RCE", "Open Relay", "User Enumeration"]},
    53: {"service": "DNS", "vulns": ["CVE-2020-1350 SIGRed", "Zone Transfer", "DNS Amplification"]},
    80: {"service": "HTTP", "vulns": ["CVE-2021-41773 Apache Path Traversal", "CVE-2019-0211 Apache Priv Esc", "Directory Listing"]},
    110: {"service": "POP3", "vulns": ["Plaintext Credentials", "CVE-2007-1558 APOP"]},
    139: {"service": "NetBIOS", "vulns": ["CVE-2017-0143 EternalBlue", "Null Session"]},
    443: {"service": "HTTPS", "vulns": ["CVE-2014-0160 Heartbleed", "CVE-2014-3566 POODLE", "SSL/TLS Misconfiguration"]},
    445: {"service": "SMB", "vulns": ["CVE-2017-0144 EternalBlue", "CVE-2020-0796 SMBGhost", "CVE-2009-3103 SMBv2"]},
    1433: {"service": "MSSQL", "vulns": ["CVE-2020-0618 MSSQL RCE", "Default SA Password", "xp_cmdshell"]},
    3306: {"service": "MySQL", "vulns": ["CVE-2012-2122 Auth Bypass", "Default Root No Password", "UDF RCE"]},
    3389: {"service": "RDP", "vulns": ["CVE-2019-0708 BlueKeep", "CVE-2019-1181 DejaBlue", "Weak Credentials"]},
    5432: {"service": "PostgreSQL", "vulns": ["CVE-2019-9193 RCE", "Default Credentials", "pg_hba.conf Misconfiguration"]},
    5900: {"service": "VNC", "vulns": ["CVE-2006-2369 Auth Bypass", "No Authentication", "Weak Password"]},
    6379: {"service": "Redis", "vulns": ["CVE-2022-0543 Redis Lua RCE", "No Auth Required", "SSH Key Injection"]},
    8080: {"service": "HTTP-Alt", "vulns": ["Tomcat Default Credentials", "Jenkins Unauthenticated", "Proxy Misconfiguration"]},
    8443: {"service": "HTTPS-Alt", "vulns": ["Management Console Exposed", "Default Credentials"]},
    27017: {"service": "MongoDB", "vulns": ["No Authentication", "CVE-2013-1892 RCE", "Data Exposure"]},
}


def scan_port(host, port, timeout=2):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(timeout)
        result = sock.connect_ex((host, port))
        sock.close()
        return result == 0
    except Exception:
        return False


def grab_banner(host, port):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(3)
        sock.connect((host, port))
        sock.send(b"HEAD / HTTP/1.0\r\n\r\n")
        banner = sock.recv(1024).decode("utf-8", errors="replace").strip()
        sock.close()
        return banner[:100]
    except Exception:
        return "-"


def run():
    host = console.input("[bold white]  Hedef IP/Domain: [/bold white]").strip()
    if not host:
        console.print("[red]  Hedef gerekli.[/red]")
        return

    try:
        resolved = socket.gethostbyname(host)
    except socket.gaierror:
        console.print("[red]  Host cozumlenemedi.[/red]")
        return

    console.print(f"\n[#a78bfa]  TaranÄ±yor: {host} ({resolved})[/#a78bfa]")

    open_ports = []

    with console.status("[magenta]  Portlar taraniyor...[/magenta]", spinner="moon"):
        for port in VULN_PORTS:
            if scan_port(resolved, port):
                banner = grab_banner(resolved, port)
                open_ports.append((port, VULN_PORTS[port], banner))

    if open_ports:
        table = Table(title=f"ðŸŒ• Exploit Tarama - {host}", border_style="purple", show_header=True, header_style="bold magenta")
        table.add_column("Port", style="bold #a78bfa", justify="center", width=6)
        table.add_column("Servis", style="white", width=12)
        table.add_column("CVE / Zafiyet", style="red", min_width=30)
        table.add_column("Banner", style="dim", width=25)

        for port, info, banner in open_ports:
            vulns = "\n".join(info["vulns"])
            table.add_row(str(port), info["service"], vulns, banner[:25])

        console.print()
        console.print(table)
        console.print(f"\n[#a78bfa]  {len(open_ports)} acik port / {sum(len(v['vulns']) for _, v, _ in open_ports)} potansiyel zafiyet.[/#a78bfa]")
    else:
        console.print("[dim]  Bilinen portlarda acik port bulunamadi.[/dim]")
